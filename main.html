<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Waste Facility Locator ‚Äî Store & Accounts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        body {
            font-family: 'Source Sans 3', 'Source Sans Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #0d1117;
            color: #c9d1d9;
            font-size: 15px;
            line-height: 1.6;
        }

        #map {
            height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .leaflet-control-geocoder {
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .fade-in {
            animation: fadeIn .2s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pointsUpdate {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                background: #238636;
            }

            100% {
                transform: scale(1);
            }
        }

        .points-updated {
            animation: pointsUpdate 0.5s ease-in-out;
        }

        .hr-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .hr-card:hover {
            border-color: #39c463;
            box-shadow: 0 4px 16px rgba(57, 196, 99, 0.1);
        }

        .hr-btn {
            background: #238636;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hr-btn:hover {
            background: #2ea043;
        }

        .hr-btn-secondary {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        .hr-btn-secondary:hover {
            background: #30363d;
            border-color: #8b949e;
        }

        .hr-green {
            color: #39c463;
        }

        .hr-text {
            color: #8b949e;
        }

        .hr-heading {
            color: #ffffff;
            font-weight: 700;
        }

        /* Custom routing line styles */
        .leaflet-routing-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #c9d1d9;
        }

        .leaflet-routing-alt {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 10px;
            margin: 5px;
            border-radius: 6px;
        }

        .leaflet-routing-alt:hover {
            background: #21262d;
            border-color: #39c463;
        }

        /* Make route line more visible */
        .leaflet-routing-container-hide {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 pb-4" style="border-bottom: 1px solid #30363d;">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold hr-green">E-Waste Facility Locator</h1>
                        <p class="text-sm hr-text mt-1">Locate certified collection points, earn points and redeem them
                            in the eco-store.</p>
                    </div>
                    <div id="header-points-display" class="hidden px-6 py-3 rounded-lg text-center animate-pulse"
                        style="background: #0d1117; border: 2px solid #39c463; min-width: 140px; box-shadow: 0 0 10px rgba(57, 196, 99, 0.3);">
                        <p class="text-xs hr-text mb-1">üí∞ Available Points</p>
                        <p class="text-3xl font-bold hr-green" id="header-points">0</p>
                    </div>
                </div>
                <nav class="space-x-2">
                    <button id="nav-home" class="px-4 py-2 rounded-lg hr-btn-secondary">Home</button>
                    <button id="nav-edump" class="px-4 py-2 rounded-lg hr-btn-secondary">E-Dump</button>
                    <button id="nav-store" class="px-4 py-2 rounded-lg hr-btn-secondary">Store</button>
                    <button id="nav-account" class="px-4 py-2 rounded-lg hr-btn-secondary">Account</button>
                    <button id="login-btn" class="px-4 py-2 rounded-lg hr-btn hidden">Logout</button>
                    <button id="open-login-btn" class="px-4 py-2 rounded-lg hr-btn">Login / Register</button>
                </nav>
            </div>
        </header>

        <!-- Status -->
        <div id="location-status" class="mb-4 p-3 rounded-lg hr-card hidden"
            style="background: #1c2128; border-color: #39c463;">
            <i class="fas fa-info-circle mr-2 hr-green"></i><span id="status-text" class="hr-text"></span>
        </div>

        <!-- SPA views -->
        <main>
            <!-- HOME (DESCRIPTION, IMAGES, CONTACT + SCROLLABLE SUPPORT) -->
            <section id="view-home" class="hr-card p-8 mb-6">
                <!-- Hero Section -->
                <div class="mb-10">
                    <h2 class="text-4xl md:text-5xl font-bold mb-5" style="color: #ffffff; letter-spacing: -0.5px;">
                        Recycle Responsibly.<br>
                        <span class="hr-green">Earn Rewards.</span>
                    </h2>
                    <p class="text-lg hr-text mb-6 leading-relaxed max-w-3xl">
                        India's premier platform for certified e-waste recycling. Locate collection centers,
                        estimate device value, and earn eco-points redeemable for sustainable products.
                    </p>
                    <div class="flex gap-4">
                        <button id="hero-edump" class="hr-btn px-6 py-3 rounded-lg font-semibold text-base">
                            <i class="fas fa-map-marker-alt mr-2"></i>Find Collection Centers
                        </button>
                        <button id="hero-store" class="hr-btn-secondary px-6 py-3 rounded-lg font-semibold text-base">
                            <i class="fas fa-store mr-2"></i>Browse Eco-Store
                        </button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-10">
                    <div class="md:w-2/3">
                        <h3 class="text-2xl font-bold mb-4 hr-heading">Why Choose E-Waste Recycling?</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="p-4 rounded-lg" style="background: #0d1117; border: 1px solid #30363d;">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-leaf text-2xl hr-green mt-1"></i>
                                    <div>
                                        <h4 class="font-semibold hr-heading mb-1">Environmental Protection</h4>
                                        <p class="text-sm hr-text">Prevents toxic materials from contaminating soil and
                                            water sources</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 rounded-lg" style="background: #0d1117; border: 1px solid #30363d;">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-recycle text-2xl hr-green mt-1"></i>
                                    <div>
                                        <h4 class="font-semibold hr-heading mb-1">Resource Recovery</h4>
                                        <p class="text-sm hr-text">Extracts valuable metals like gold, silver, and
                                            palladium from old devices</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 rounded-lg" style="background: #0d1117; border: 1px solid #30363d;">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-hands-helping text-2xl hr-green mt-1"></i>
                                    <div>
                                        <h4 class="font-semibold hr-heading mb-1">Circular Economy</h4>
                                        <p class="text-sm hr-text">Supports sustainable livelihoods and reduces
                                            dependency on mining</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-2xl font-bold mb-4 hr-heading">Contact & Support</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="p-4 rounded-lg" style="background: #0d1117; border: 1px solid #30363d;">
                                    <p class="font-semibold hr-heading mb-2">Email</p>
                                    <p class="text-sm hr-green"><a href="mailto:support@ewaste-locator.com"
                                            class="hover:underline">support@ewaste-locator.com</a></p>
                                    <p class="mt-2 text-sm hr-text">We typically respond within 24‚Äì48 hours.</p>
                                </div>
                                <div class="p-4 rounded-lg" style="background: #0d1117; border: 1px solid #30363d;">
                                    <p class="font-semibold hr-heading mb-2">Phone</p>
                                    <p class="text-sm hr-text">+91 98765 43210</p>
                                    <p class="mt-2 text-sm hr-text">Mon ‚Äî Fri, 9:00 AM ‚Äî 6:00 PM IST</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="md:w-1/3">
                        <h3 class="text-2xl font-semibold mb-4 hr-heading">Gallery</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <img src="https://www.jivamaterials.com/wp-content/uploads/2025/01/biodegradable-PCBs-1000x568.jpg"
                                alt="E-Waste" class="rounded-lg h-40 w-full object-cover"
                                style="border: 1px solid #30363d;">
                            <img src="https://static.wixstatic.com/media/49bcab_8e6e56bbeab544689f0d7090d1ac1634~mv2.jpeg/v1/fill/w_852,h_518,al_c,lg_1,q_85,enc_avif,quality_auto/49bcab_8e6e56bbeab544689f0d7090d1ac1634~mv2.jpeg"
                                alt="Eco Friendly" class="rounded-lg h-40 w-full object-cover"
                                style="border: 1px solid #30363d;">
                        </div>

                        <div class="mt-6 p-4 rounded-lg" style="background: #0d1117; border: 1px solid #30363d;">
                            <h4 class="font-semibold hr-heading mb-3">Quick Links</h4>
                            <ul class="text-sm space-y-2">
                                <li><button id="goto-edump" class="hr-green hover:underline text-left">‚Üí Find a nearby
                                        collection center (E-Dump)</button></li>
                                <li><button id="goto-store" class="hr-green hover:underline text-left">‚Üí Browse the
                                        Eco-Store</button></li>
                                <li><button id="goto-account" class="hr-green hover:underline text-left">‚Üí Manage your
                                        account</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- E-DUMP (moved home content: map + estimator) -->
            <section id="view-edump" class="hidden hr-card p-6 mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-xl font-bold mb-3 hr-heading">Find a Collection Center</h2>
                        <div id="map" class="mb-4"></div>
                        <div id="nearest-facility" class="mt-3 hidden">
                            <h3 class="text-lg font-semibold hr-green">Nearest Facility:</h3>
                            <div id="facility-info" class="mt-2 p-3 rounded-lg"
                                style="background: #0d1117; border: 1px solid #39c463;"></div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold mb-3 hr-heading">Estimate Your Device's Value</h2>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <select id="device-select" class="w-full p-3 rounded-lg"
                                style="background: #0d1117; border: 1px solid #30363d; color: #c9d1d9;">
                                <option value="">-- Select your device --</option>
                                <option value="smartphone">Smartphone</option>
                                <option value="laptop">Laptop</option>
                                <option value="tablet">Tablet</option>
                                <option value="desktop-pc">Desktop PC</option>
                            </select>
                            <button id="calculate-credits-btn"
                                class="hr-btn font-bold py-3 px-6 rounded-lg whitespace-nowrap">Calculate &
                                Claim</button>
                        </div>

                        <div id="credit-results" class="hidden mt-6">
                            <h3 class="text-lg font-semibold hr-heading mb-3">Estimated Recovery Value</h3>
                            <div class="text-center p-4 my-3 rounded-lg"
                                style="background: #0d1117; border: 1px solid #30363d;">
                                <p class="text-4xl font-bold hr-green" id="credit-points">0</p>
                                <p class="hr-text text-sm mt-1">Credit Points</p>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold hr-heading mb-2">Precious Metals</h4>
                                <ul id="precious-metals-list" class="list-disc list-inside hr-text space-y-1"></ul>
                            </div>
                            <div>
                                <h4 class="font-semibold hr-heading mb-2">Harmful Components</h4>
                                <ul id="harmful-components-list" class="list-disc list-inside hr-text space-y-1"></ul>
                            </div>
                            <p class="mt-4 text-sm hr-text">Click <strong class="hr-green">Calculate & Claim</strong> to
                                both estimate and add points to your account (if logged in).</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STORE -->
            <section id="view-store" class="hidden hr-card p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold hr-heading">Eco-Store (Redeem with points)</h2>
                    <div class="space-x-3 flex items-center">
                        <span class="text-sm hr-text">Your cart: <strong class="hr-green"
                                id="cart-count">0</strong></span>
                        <button id="view-cart-btn" class="hr-btn px-4 py-2 rounded-lg">View Cart</button>
                    </div>
                </div>
                <div id="products-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </section>

            <!-- CART MODAL / PAGE -->
            <div id="cart-modal" class="hidden fixed inset-0 bg-opacity-75 flex justify-center items-center z-50"
                style="background: rgba(0, 0, 0, 0.8);">
                <div class="rounded-lg p-6 w-[420px] shadow-2xl"
                    style="background: #161b22; border: 1px solid #30363d;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold hr-heading">Your Cart</h2>
                        <button id="close-cart" class="hr-text text-2xl hover:text-white">&times;</button>
                    </div>

                    <p class="font-semibold mb-3 hr-text">
                        Total Points: <span id="cart-total" class="hr-green">0</span>
                    </p>

                    <div id="cart-items" class="pt-2 mb-4 max-h-48 overflow-y-auto"
                        style="border-top: 1px solid #30363d;"></div>

                    <label for="delivery-address" class="block hr-heading font-medium mb-2">
                        Delivery Address
                    </label>
                    <textarea id="delivery-address" rows="3"
                        class="w-full rounded-md p-3 text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-green-500"
                        style="background: #0d1117; border: 1px solid #30363d; color: #c9d1d9;"
                        placeholder="Enter your delivery address here..."></textarea>

                    <div class="flex justify-end space-x-2">
                        <button id="close-cart-bottom" class="hr-btn-secondary px-4 py-2 rounded-md">
                            Close
                        </button>
                        <button id="checkout-btn" class="hr-btn px-4 py-2 rounded-md">
                            Checkout with Points
                        </button>
                    </div>
                </div>
            </div>

            <!-- ACCOUNT -->
            <section id="view-account" class="hidden hr-card p-6 mb-6">
                <div id="account-unauth" class="space-y-3">
                    <h2 class="text-xl font-bold hr-heading">Account</h2>
                    <p class="hr-text">You are not logged in. Please <button id="open-login-btn-2"
                            class="hr-green hover:underline">Login</button> or Register to collect & redeem points.</p>
                </div>
                <div id="account-auth" class="hidden space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold hr-heading" id="account-username"></h2>
                            <p class="text-sm hr-text" id="account-email"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm hr-text">Available Points</p>
                            <p class="text-3xl font-bold hr-green" id="account-points">0</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold hr-heading mb-3">Transaction History</h3>
                        <div id="tx-history" class="mt-2 space-y-2 max-h-48 overflow-auto text-sm"></div>
                    </div>
                </div>
            </section>
        </main>

        <!-- LOGIN / REGISTER MODAL -->
        <div id="auth-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50"
            style="background: rgba(0, 0, 0, 0.8);">
            <div class="rounded-xl shadow-2xl p-6 w-full max-w-md fade-in"
                style="background: #161b22; border: 1px solid #30363d;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold hr-heading" id="auth-title">Login</h3>
                    <button id="close-auth" class="hr-text text-2xl hover:text-white">&times;</button>
                </div>
                <div id="auth-forms">
                    <form id="login-form" class="space-y-4">
                        <input id="login-email" placeholder="Email" type="email" class="w-full p-3 rounded-lg"
                            style="background: #0d1117; border: 1px solid #30363d; color: #c9d1d9;" required />
                        <input id="login-password" placeholder="Password" type="password" class="w-full p-3 rounded-lg"
                            style="background: #0d1117; border: 1px solid #30363d; color: #c9d1d9;" required />
                        <div class="flex justify-between items-center">
                            <button type="submit" class="hr-btn px-5 py-2 rounded-lg">Login</button>
                            <button id="show-register" type="button" class="text-sm hr-green hover:underline">New user?
                                Register</button>
                        </div>
                    </form>

                    <form id="register-form" class="space-y-4 hidden">
                        <input id="reg-name" placeholder="Full name" type="text" class="w-full p-3 rounded-lg"
                            style="background: #0d1117; border: 1px solid #30363d; color: #c9d1d9;" required />
                        <input id="reg-email" placeholder="Email" type="email" class="w-full p-3 rounded-lg"
                            style="background: #0d1117; border: 1px solid #30363d; color: #c9d1d9;" required />
                        <input id="reg-password" placeholder="Password" type="password" class="w-full p-3 rounded-lg"
                            style="background: #0d1117; border: 1px solid #30363d; color: #c9d1d9;" required />
                        <div class="flex justify-between items-center">
                            <button type="submit" class="hr-btn px-5 py-2 rounded-lg">Register</button>
                            <button id="show-login" type="button" class="text-sm hr-green hover:underline">Already have
                                an account? Login</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ----------------- Data -----------------
        const deviceMetalsDB = {
            'smartphone': { precious: { 'Gold': '0.034', 'Silver': '0.35', 'Palladium': '0.015' }, harmful: { 'Lead': 'Can damage nervous systems', 'Mercury': 'Toxic to organs and nervous system' } },
            'laptop': { precious: { 'Gold': '0.2', 'Silver': '1.0', 'Palladium': '0.05' }, harmful: { 'Lead': 'Found in solder and batteries', 'Cadmium': 'Used in rechargeable batteries, toxic' } },
            'tablet': { precious: { 'Gold': '0.05', 'Silver': '0.5', 'Palladium': '0.02' }, harmful: { 'Lead': 'Present in circuit boards', 'Brominated Flame Retardants': 'Can disrupt hormone functions' } },
            'desktop-pc': { precious: { 'Gold': '0.5', 'Silver': '2.5', 'Palladium': '0.1' }, harmful: { 'Lead': 'High amounts in CRT monitors', 'Mercury': 'Used in switches and flat-screen monitors' } }
        };
        const facilities = [
            // ---------- BENGALURU ----------
            {
                name: "Eco Globe E-Waste Recyclers",
                address: "Plot No. 87, 2nd Phase, 2nd Sector, Ramanagar, Bidadi Industrial Area, Bengaluru 562109",
                lat: 12.8275,
                lng: 77.4498
            },
            {
                name: "Eco-Ewaste Recyclers India Pvt Ltd",
                address: "41/1, 42/2, 19 & 20, Mutachari Industrial Estate, Mysore Road, Bengaluru 560039",
                lat: 12.9505,
                lng: 77.5440
            },
            {
                name: "Trishyirya Recycling India Pvt. Ltd.",
                address: "4th Phase, Peenya Industrial Estate, Bengaluru 560058",
                lat: 13.0150,
                lng: 77.4900
            },
            {
                name: "Samarthanam Trust for the Disabled (Peenya)",
                address: "No. 66, 6th main, 3rd Phase, Peenya Industrial Area, Bengaluru 560058",
                lat: 13.0140,
                lng: 77.4895
            },
            {
                name: "E-Ward & Co.",
                address: "No.6/1B, 14th Cross, Hosur Road, Bommanahalli, Bengaluru 560068",
                lat: 12.9250,
                lng: 77.6240
            },

            // ---------- HYDERABAD ----------
            {
                name: "Ramky E-Waste Recycling Facility",
                address: "Plot No. 38, IDA Mallapur, Hyderabad 500076",
                lat: 17.4474,
                lng: 78.5751
            },
            {
                name: "Green India Recycling",
                address: "IDA Cherlapally Phase 2, Hyderabad 500051",
                lat: 17.4790,
                lng: 78.6046
            },

            // ---------- CHENNAI ----------
            {
                name: "E-Parisaraa Pvt Ltd (Chennai Unit)",
                address: "No. 16, Vyasarpadi Industrial Estate, Chennai 600039",
                lat: 13.1130,
                lng: 80.2580
            },
            {
                name: "TES-AMM India",
                address: "Kandanchavadi, Old Mahabalipuram Road, Chennai 600096",
                lat: 12.9670,
                lng: 80.2450
            },

            // ---------- MUMBAI ----------
            {
                name: "EcoCentric Management Pvt Ltd",
                address: "Saki Naka, Andheri East, Mumbai 400072",
                lat: 19.1024,
                lng: 72.8826
            },
            {
                name: "Ecoreco (Eco Recycling Ltd)",
                address: "Andheri ‚Äì Kurla Road, Mumbai 400059",
                lat: 19.1123,
                lng: 72.8697
            },

            // ---------- DELHI NCR ----------
            {
                name: "Cerebra Integrated Technologies",
                address: "Plot 110, Ecotech III, Greater Noida, Delhi NCR 201306",
                lat: 28.4950,
                lng: 77.5250
            },
            {
                name: "Karo Sambhav Collection Center",
                address: "Okhla Industrial Estate, New Delhi 110020",
                lat: 28.5505,
                lng: 77.2684
            },

            // ---------- PUNE ----------
            {
                name: "SWaCH E-Waste Collection Center",
                address: "Aundh, Pune 411007",
                lat: 18.5603,
                lng: 73.8077
            },
            {
                name: "Cummins India Recycling Unit",
                address: "Kothrud Industrial Area, Pune 411038",
                lat: 18.5074,
                lng: 73.8077
            },

            // ---------- KOLKATA ----------
            {
                name: "Hulladek Recycling Pvt Ltd",
                address: "192, Shyama Prasad Mukherjee Road, Kolkata 700026",
                lat: 22.5090,
                lng: 88.3520
            },
            {
                name: "Greenwaves Environmental Solutions",
                address: "Budge Budge Trunk Road, Kolkata 700137",
                lat: 22.4713,
                lng: 88.1803
            }
        ];


        const products = [
            {
                id: 1,
                name: 'Bamboo Toothbrush (Pack)',
                price: 120,
                desc: 'Eco-friendly bamboo toothbrushes (pack of 4).',
                img: "https://i.postimg.cc/5y73DVV6/Gemini-Generated-Image-yq043pyq043pyq04-1.png",
                height: 200,
                width: 200
            },
            {
                id: 2,
                name: 'Reusable Tote Bag',
                price: 200,
                desc: 'Sturdy reusable shopping bag.',
                img: 'https://i.postimg.cc/Pr0bDKrT/Gemini-Generated-Image-yq043pyq043pyq04-2.png',
                height: 200,
                width: 200
            },
            {
                id: 3,
                name: 'Solar Power Bank',
                price: 1200,
                desc: 'Portable solar charging bank.',
                img: 'https://i.postimg.cc/02KD9mGS/Gemini-Generated-Image-yq043pyq043pyq04-3.png',
                height: 200,
                width: 200
            },
            {
                id: 4,
                name: 'Recycled Notebook',
                price: 80,
                desc: 'Notebook made from recycled paper.',
                img: 'https://i.postimg.cc/4y77Nkch/Gemini-Generated-Image-yq043pyq043pyq04.png',
                height: 200,
                width: 200


            },
            {
                id: 5,
                name: 'Ecofriendly photo frame',
                price: 250,
                desc: 'photo frame made from recycled wood.',
                img: 'https://i.postimg.cc/MKwdHq53/Gemini-Generated-Image-ih0xyqih0xyqih0x-1.png',
                height: 200,
                width: 200
            },
            {
                id: 6,
                name: 'Ecofriendly mobile holder',
                price: 300,
                desc: 'mobile phone holder made from recycled wood.',
                img: 'https://i.postimg.cc/DwJJKbsh/Gemini-Generated-Image-xnk2hxxnk2hxxnk2.png',
                height: 200,
                width: 200
            }

        ];

        // ----------------- Users & Auth (Database API) -----------------
        const API_URL = 'http://localhost:3000/api';
        let currentUser = null;

        function getToken() { return localStorage.getItem('ewaste_token'); }
        function setToken(token) { localStorage.setItem('ewaste_token', token); }
        function removeToken() { localStorage.removeItem('ewaste_token'); }

        async function fetchWithAuth(url, options = {}) {
            const token = getToken();
            if (token) {
                options.headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            }
            const response = await fetch(url, options);
            return response;
        }

        async function getCurrentUser() {
            const token = getToken();
            if (!token) return null;
            try {
                const response = await fetchWithAuth(`${API_URL}/users/me`);
                if (response.ok) {
                    currentUser = await response.json();
                    return currentUser;
                }
            } catch (error) {
                console.error('Error fetching user:', error);
            }
            return null;
        }

        // ----------------- SPA Navigation -----------------
        const viewHome = document.getElementById('view-home');
        const viewEdump = document.getElementById('view-edump');
        const viewStore = document.getElementById('view-store');
        const viewAccount = document.getElementById('view-account');
        const openLoginBtn = document.getElementById('open-login-btn');
        const openLoginBtn2 = document.getElementById('open-login-btn-2');
        const loginBtn = document.getElementById('login-btn');

        let map; // Leaflet map
        function showView(view) {
            // hide all
            viewHome.classList.add('hidden'); viewEdump.classList.add('hidden'); viewStore.classList.add('hidden'); viewAccount.classList.add('hidden');
            // show requested
            view.classList.remove('hidden');

            // init map when showing E-Dump
            if (view === viewEdump) {
                if (!map) { initMap(); }
                else { setTimeout(() => map.invalidateSize(), 200); }
            }
        }

        document.getElementById('nav-home').addEventListener('click', () => showView(viewHome));
        document.getElementById('nav-edump').addEventListener('click', () => showView(viewEdump));
        document.getElementById('nav-store').addEventListener('click', () => showView(viewStore));
        document.getElementById('nav-account').addEventListener('click', () => showView(viewAccount));

        // quick links from home
        document.getElementById('goto-edump').addEventListener('click', () => showView(viewEdump));
        document.getElementById('goto-store').addEventListener('click', () => showView(viewStore));
        document.getElementById('goto-account').addEventListener('click', () => showView(viewAccount));

        // hero buttons
        document.getElementById('hero-edump').addEventListener('click', () => showView(viewEdump));
        document.getElementById('hero-store').addEventListener('click', () => showView(viewStore));

        // ----------------- Auth Modal -----------------
        const authModal = document.getElementById('auth-modal');
        const closeAuth = document.getElementById('close-auth');
        const authTitle = document.getElementById('auth-title');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');

        function openAuth(mode = 'login') {
            authModal.classList.remove('hidden');
            if (mode === 'login') { authTitle.textContent = 'Login'; loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); }
            else { authTitle.textContent = 'Register'; loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); }
        }
        openLoginBtn.addEventListener('click', () => openAuth('login'));
        openLoginBtn2?.addEventListener('click', () => openAuth('login'));
        closeAuth.addEventListener('click', () => authModal.classList.add('hidden'));
        showRegisterBtn.addEventListener('click', () => openAuth('register'));
        showLoginBtn.addEventListener('click', () => openAuth('login'));

        // ----------------- Register/Login -----------------
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim().toLowerCase();
            const password = document.getElementById('reg-password').value;

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                const data = await response.json();

                if (response.ok) {
                    setToken(data.token);
                    currentUser = data.user;
                    await updateAuthState();
                    authModal.classList.add('hidden');
                    alert('‚úÖ Registered & logged in successfully!');
                } else {
                    alert(data.message || 'Registration failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                if (response.ok) {
                    setToken(data.token);
                    currentUser = data.user;
                    
                    // Redirect based on role
                    if (data.user.role === 'admin') {
                        alert('‚úÖ Welcome Admin! Redirecting to admin dashboard...');
                        window.location.href = '/admin.html';
                    } else {
                        await updateAuthState();
                        authModal.classList.add('hidden');
                        alert('‚úÖ Logged in successfully!');
                    }
                } else {
                    alert(data.message || 'Login failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        loginBtn.addEventListener('click', () => {
            removeToken();
            currentUser = null;
            updateAuthState();
            alert('Logged out successfully!');
        });

        // ----------------- Update Auth State -----------------
        async function updateAuthState(animate = false) {
            const user = await getCurrentUser();

            if (user) {
                document.getElementById('account-username').textContent = user.name || 'User';
                document.getElementById('account-email').textContent = user.email;
                document.getElementById('account-points').textContent = user.points || 0;

                // Update header points display with animation
                const headerPointsEl = document.getElementById('header-points');
                const headerDisplayEl = document.getElementById('header-points-display');
                headerPointsEl.textContent = user.points || 0;
                headerDisplayEl.classList.remove('hidden');

                // Add animation when points change
                if (animate) {
                    headerDisplayEl.classList.add('points-updated');
                    setTimeout(() => headerDisplayEl.classList.remove('points-updated'), 500);
                }

                // tx history
                const txDiv = document.getElementById('tx-history'); txDiv.innerHTML = '';
                (user.transactions || []).slice().reverse().forEach(t => {
                    const d = document.createElement('div'); d.className = 'p-3 rounded';
                    d.style.cssText = 'background: #0d1117; border: 1px solid #30363d;';
                    const displayDate = new Date(t.date).toLocaleString();
                    d.innerHTML = `<div class="text-sm hr-heading"><strong>${t.device || t.action || 'Activity'}</strong> ‚Äî <span class="hr-green">${t.points || ''} pts</span></div><div class="text-xs hr-text mt-1">${displayDate}</div>`;
                    txDiv.appendChild(d);
                });

                document.getElementById('account-unauth').classList.add('hidden');
                document.getElementById('account-auth').classList.remove('hidden');
                loginBtn.classList.remove('hidden');
                openLoginBtn.classList.add('hidden');
                openLoginBtn2?.classList.add('hidden');
            } else {
                document.getElementById('account-unauth').classList.remove('hidden');
                document.getElementById('account-auth').classList.add('hidden');
                loginBtn.classList.add('hidden');
                openLoginBtn.classList.remove('hidden');
                openLoginBtn2?.classList.remove('hidden');

                // Hide header points display when logged out
                document.getElementById('header-points-display').classList.add('hidden');
            }
        }
        updateAuthState();

        // ----------------- Leaflet Map -----------------
        let userLocation = null;
        let currentRoute = null;
        let userMarker = null;
        let routeLine = null;

        function initMap() {
            // Initialize map
            map = L.map('map').setView([20, 78], 5);

            // Base layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Facility locations (example data)
            const facilities = [
                { name: "Eco Globe E-Waste Recyclers", lat: 12.8275, lng: 77.4498, address: "Bidadi Industrial Area, Bengaluru 562109" },
                { name: "Eco-Ewaste Recyclers India Pvt Ltd", lat: 12.9505, lng: 77.5440, address: "Mysore Road, Bengaluru 560039" },
                { name: "Trishyirya Recycling India Pvt. Ltd.", lat: 13.0150, lng: 77.4900, address: "Peenya Industrial Estate, Bengaluru 560058" },
                { name: "Samarthanam Trust for the Disabled (Peenya)", lat: 13.0140, lng: 77.4895, address: "Peenya Industrial Area, Bengaluru 560058" },
                { name: "E-Ward & Co.", lat: 12.9250, lng: 77.6240, address: "Bommanahalli, Bengaluru 560068" },
                { name: "Ramky E-Waste Recycling Facility", lat: 17.4474, lng: 78.5751, address: "IDA Mallapur, Hyderabad 500076" },
                { name: "Green India Recycling", lat: 17.4790, lng: 78.6046, address: "IDA Cherlapally Phase 2, Hyderabad 500051" },
                { name: "E-Parisaraa Pvt Ltd (Chennai Unit)", lat: 13.1130, lng: 80.2580, address: "Vyasarpadi Industrial Estate, Chennai 600039" },
                { name: "TES-AMM India", lat: 12.9670, lng: 80.2450, address: "Old Mahabalipuram Road, Chennai 600096" },
                { name: "EcoCentric Management Pvt Ltd", lat: 19.1024, lng: 72.8826, address: "Saki Naka, Andheri East, Mumbai 400072" },
                { name: "Ecoreco (Eco Recycling Ltd)", lat: 19.1123, lng: 72.8697, address: "Andheri-Kurla Road, Mumbai 400059" },
                { name: "Cerebra Integrated Technologies", lat: 28.4950, lng: 77.5250, address: "Ecotech III, Greater Noida, Delhi NCR 201306" },
                { name: "Karo Sambhav Collection Center", lat: 28.5505, lng: 77.2684, address: "Okhla Industrial Estate, New Delhi 110020" },
                { name: "SWaCH E-Waste Collection Center", lat: 18.5603, lng: 73.8077, address: "Aundh, Pune 411007" },
                { name: "Cummins India Recycling Unit", lat: 18.5074, lng: 73.8077, address: "Kothrud Industrial Area, Pune 411038" },
                { name: "Hulladek Recycling Pvt Ltd", lat: 22.5090, lng: 88.3520, address: "Shyama Prasad Mukherjee Road, Kolkata 700026" },
                { name: "Greenwaves Environmental Solutions", lat: 22.4713, lng: 88.1803, address: "Budge Budge Trunk Road, Kolkata 700137" }
            ];

            // Add facility markers with click event for routing
            facilities.forEach(facility => {
                const marker = L.marker([facility.lat, facility.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <b>${facility.name}</b><br>
                            ${facility.address}
                        </div>
                    `);

                // Show route when marker is clicked
                marker.on('click', function () {
                    showRouteToFacility(facility.lat, facility.lng, facility.name);
                });
            });

            // Add Geocoder (Search bar)
            const geocoder = L.Control.geocoder({
                defaultMarkGeocode: false,
                placeholder: "Search for a city, area, or address...",
                collapsed: false
            })
                .on('markgeocode', function (e) {
                    const center = e.geocode.center;
                    L.marker(center)
                        .addTo(map)
                        .bindPopup(`<b>${e.geocode.name}</b>`)
                        .openPopup();
                    map.setView(center, 12);
                })
                .addTo(map);

            // Auto-locate user on map load
            locateUser();
        }

        // Function to show route from current location to facility
        window.showRouteToFacility = function (destLat, destLng, facilityName) {
            if (!userLocation) {
                alert('Please allow location access first to get directions!');
                locateUser();
                return;
            }

            // Remove existing route if any
            if (currentRoute) {
                map.removeControl(currentRoute);
            }
            if (routeLine) {
                map.removeLayer(routeLine);
            }

            // Create routing control with enhanced styling
            currentRoute = L.Routing.control({
                waypoints: [
                    L.latLng(userLocation.lat, userLocation.lng),
                    L.latLng(destLat, destLng)
                ],
                routeWhileDragging: false,
                geocoder: L.Control.Geocoder.nominatim(),
                lineOptions: {
                    styles: [
                        { color: '#FFFFFF', weight: 10, opacity: 0.6 },  // White border for contrast
                        { color: '#4285F4', weight: 7, opacity: 1.0 }    // Google Maps blue
                    ],
                    extendToWaypoints: true,
                    missingRouteTolerance: 0
                },
                createMarker: function (i, waypoint, n) {
                    if (i === 0) {
                        // Start marker (user location) - Blue
                        return L.marker(waypoint.latLng, {
                            icon: L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).bindPopup('<b>üìç Your Location</b>');
                    } else {
                        // End marker (facility) - Green
                        return L.marker(waypoint.latLng, {
                            icon: L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).bindPopup(`<b>üéØ ${facilityName}</b>`);
                    }
                },
                show: true,
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                showAlternatives: false,
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                })
            }).on('routesfound', function (e) {
                // Draw a custom polyline for better visibility
                const routes = e.routes;
                const route = routes[0];
                const coords = route.coordinates;

                // Remove old route line if exists
                if (routeLine) {
                    map.removeLayer(routeLine);
                }

                // Create a highly visible polyline (Google Maps style)
                routeLine = L.polyline(coords, {
                    color: '#4285F4',      // Google Maps blue
                    weight: 8,             // Thick line
                    opacity: 1.0,          // Fully opaque
                    lineJoin: 'round',     // Smooth corners
                    lineCap: 'round'       // Smooth ends
                }).addTo(map);

                // Add white border for contrast
                L.polyline(coords, {
                    color: '#FFFFFF',
                    weight: 11,
                    opacity: 0.5,
                    lineJoin: 'round',
                    lineCap: 'round'
                }).addTo(map).bringToBack();

                // Bring the blue line to front
                routeLine.bringToFront();
            }).addTo(map);

            // Show status message
            const status = document.getElementById('location-status');
            const statusText = document.getElementById('status-text');
            status.classList.remove('hidden');
            statusText.textContent = `üó∫Ô∏è Showing route to ${facilityName}`;
            setTimeout(() => status.classList.add('hidden'), 4000);
        }

        // Initialize map after DOM is loaded


        function locateUser() {
            const status = document.getElementById('location-status');
            const statusText = document.getElementById('status-text');
            status.classList.remove('hidden'); statusText.textContent = 'Locating your position...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude; const lng = pos.coords.longitude;

                    // Store user location for routing
                    userLocation = { lat, lng };

                    map.setView([lat, lng], 12);

                    // Remove old user marker if exists
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    // Add user location marker with custom blue icon
                    userMarker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map).bindPopup('üìç You are here').openPopup();

                    showNearestFacility(lat, lng);
                    statusText.textContent = '‚úÖ Location found. Click any facility marker to get directions!';
                    setTimeout(() => status.classList.add('hidden'), 4000);
                }, err => {
                    statusText.textContent = '‚ùå Could not get your location. Please enable location access.';
                    setTimeout(() => status.classList.add('hidden'), 4000);
                });
            } else {
                statusText.textContent = '‚ùå Geolocation not supported by your browser.';
                setTimeout(() => status.classList.add('hidden'), 3500);
            }
        }

        function showNearestFacility(lat, lng) {
            let minDist = Infinity; let nearest = null;
            facilities.forEach(f => {
                const d = Math.sqrt(Math.pow(f.lat - lat, 2) + Math.pow(f.lng - lng, 2));
                if (d < minDist) { minDist = d; nearest = f; }
            });
            if (nearest) {
                document.getElementById('nearest-facility').classList.remove('hidden');
                document.getElementById('facility-info').innerHTML = `<b>${nearest.name}</b><br>${nearest.address}`;
            }
        }

        // ----------------- Credit Points -----------------
        document.getElementById('calculate-credits-btn').addEventListener('click', async () => {
            const device = document.getElementById('device-select').value;
            if (!device) { alert('Select a device first.'); return; }

            const token = getToken();
            if (!token) {
                alert('Please login first to claim points!');
                openAuth('login');
                return;
            }

            const data = deviceMetalsDB[device];
            let points = Math.floor(Math.random() * 51 + 50);
            document.getElementById('credit-points').textContent = points;
            const pmList = document.getElementById('precious-metals-list'); pmList.innerHTML = '';
            Object.entries(data.precious).forEach(([k, v]) => { pmList.innerHTML += `<li>${k}: ${v} g</li>`; });
            const hmList = document.getElementById('harmful-components-list'); hmList.innerHTML = '';
            Object.entries(data.harmful).forEach(([k, v]) => { hmList.innerHTML += `<li>${k}: ${v}</li>`; });
            document.getElementById('credit-results').classList.remove('hidden');

            // Add points to user account via API
            try {
                const oldPoints = currentUser?.points || 0;
                const response = await fetchWithAuth(`${API_URL}/users/claim-device`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device, points })
                });

                if (response.ok) {
                    const result = await response.json();
                    await updateAuthState(true); // Pass true to trigger animation

                    // Show success message
                    alert(`‚úÖ Success! ${points} points added to your account!\n\nOld Balance: ${oldPoints} pts\nNew Balance: ${result.points} pts\n\n‚úÖ Points saved to database!\nCheck the header and Account section to see your updated points!`);
                } else {
                    alert('Failed to claim points. Please try again.');
                }
            } catch (error) {
                alert('Error claiming points: ' + error.message);
            }
        });

        // ----------------- Products / Store -----------------
        async function renderProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '<p class="text-center hr-text col-span-3">Loading products...</p>';

            try {
                // Fetch products from API
                const response = await fetch(`${API_URL}/products`);
                if (response.ok) {
                    const dbProducts = await response.json();

                    // Merge with local product data (for images)
                    const mergedProducts = dbProducts.map(dbProd => {
                        const localProd = products.find(p => p.id === dbProd.id);
                        return {
                            ...dbProd,
                            img: localProd?.img || 'https://via.placeholder.com/200',
                            desc: localProd?.desc || dbProd.description || '',
                            height: localProd?.height || 200,
                            width: localProd?.width || 200
                        };
                    });

                    grid.innerHTML = '';

                    mergedProducts.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-4 rounded-lg flex flex-col justify-between transition';
                        div.style.cssText = 'background: #0d1117; border: 1px solid #30363d;';
                        div.onmouseenter = function () { this.style.borderColor = '#39c463'; };
                        div.onmouseleave = function () { this.style.borderColor = '#30363d'; };

                        // Stock status badge
                        let stockBadge = '';
                        let buttonDisabled = '';
                        let buttonText = 'Add to Cart';

                        if (p.stock === 0 || p.status === 'Out of Stock') {
                            stockBadge = '<span class="text-xs px-2 py-1 rounded" style="background: #f85149; color: white;">Out of Stock</span>';
                            buttonDisabled = 'disabled';
                            buttonText = 'Out of Stock';
                        } else if (p.stock <= 10 || p.status === 'Low Stock') {
                            stockBadge = `<span class="text-xs px-2 py-1 rounded" style="background: #d29922; color: white;">Only ${p.stock} left</span>`;
                        } else {
                            stockBadge = `<span class="text-xs px-2 py-1 rounded" style="background: #238636; color: white;">${p.stock} in stock</span>`;
                        }

                        div.innerHTML = `
                    <div>
                        <img src="${p.img}" alt="${p.name}" 
                            class="rounded-lg mb-3 object-cover mx-auto" 
                            style="height:${p.height}px; width:${p.width}px; border: 1px solid #30363d;">
                        <div class="flex justify-center mb-2">${stockBadge}</div>
                        <h3 class="font-semibold mb-2 text-center hr-heading">${p.name}</h3>
                        <p class="text-sm hr-text mb-2 text-center">${p.desc}</p>
                        <p class="font-bold hr-green mb-3 text-center">${p.price} pts</p>
                    </div>
                    <button class="hr-btn px-3 py-2 rounded-lg w-full ${buttonDisabled ? 'opacity-50 cursor-not-allowed' : ''}" 
                        onclick="addToCart(${p.id})" ${buttonDisabled}>${buttonText}</button>
                `;

                        grid.appendChild(div);
                    });
                } else {
                    // Fallback to local products if API fails
                    grid.innerHTML = '';
                    products.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-4 rounded-lg flex flex-col justify-between transition';
                        div.style.cssText = 'background: #0d1117; border: 1px solid #30363d;';
                        div.onmouseenter = function () { this.style.borderColor = '#39c463'; };
                        div.onmouseleave = function () { this.style.borderColor = '#30363d'; };

                        div.innerHTML = `
                    <img src="${p.img}" alt="${p.name}" 
                        class="rounded-lg mb-3 object-cover mx-auto" 
                        style="height:${p.height}px; width:${p.width}px; border: 1px solid #30363d;">
                    <h3 class="font-semibold mb-2 text-center hr-heading">${p.name}</h3>
                    <p class="text-sm hr-text mb-2 text-center">${p.desc}</p>
                    <p class="font-bold hr-green mb-3 text-center">${p.price} pts</p>
                    <button class="hr-btn px-3 py-2 rounded-lg w-full" 
                        onclick="addToCart(${p.id})">Add to Cart</button>
                `;

                        grid.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Error loading products:', error);
                grid.innerHTML = '<p class="text-center hr-text col-span-3">Error loading products. Please refresh.</p>';
            }
        }
        let cart = [];
        function addToCart(id) { cart.push(products.find(p => p.id === id)); updateCart(); }
        function updateCart() {
            document.getElementById('cart-count').textContent = cart.length;
            const itemsDiv = document.getElementById('cart-items'); itemsDiv.innerHTML = '';
            let total = 0; cart.forEach((p, i) => {
                const div = document.createElement('div'); div.className = 'flex justify-between items-center pb-2 mb-2';
                div.style.borderBottom = '1px solid #30363d';
                div.innerHTML = `<span class="hr-text">${p.name}</span><span class="hr-green">${p.price} pts <button onclick="removeFromCart(${i})" class="text-red-500 ml-2 hover:text-red-400">&times;</button></span>`;
                itemsDiv.appendChild(div); total += p.price;
            });
            document.getElementById('cart-total').textContent = total;
        }
        function removeFromCart(i) { cart.splice(i, 1); updateCart(); }
        document.getElementById('view-cart-btn').addEventListener('click', () => document.getElementById('cart-modal').classList.remove('hidden'));
        document.getElementById('close-cart').addEventListener('click', () => document.getElementById('cart-modal').classList.add('hidden'));
        document.getElementById('checkout-btn').addEventListener('click', async () => {
            const token = getToken();
            if (!token) {
                alert('Login to redeem points');
                openAuth('login');
                return;
            }

            const total = cart.reduce((a, b) => a + b.price, 0);
            const address = document.getElementById('delivery-address').value.trim();

            if (!address) {
                alert('Please enter your delivery address before checkout.');
                document.getElementById('delivery-address').focus();
                return;
            }

            if (total > (currentUser?.points || 0)) {
                alert('Not enough points');
                return;
            }

            try {
                const items = cart.map(p => ({ productId: p.id, quantity: 1 }));
                const response = await fetchWithAuth(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items, deliveryAddress: address })
                });

                if (response.ok) {
                    const result = await response.json();
                    const itemNames = cart.map(p => p.name).join(', ');

                    // Clear cart
                    cart = [];
                    updateCart();

                    // Update user state
                    await updateAuthState();

                    // Refresh products to show updated stock
                    await renderProducts();

                    // Show detailed success message
                    alert(`üéâ ORDER SUCCESSFUL!\n\n` +
                        `‚úÖ ${result.itemsOrdered} item(s) ordered\n` +
                        `üì¶ Items: ${itemNames}\n` +
                        `üí∞ Points Used: ${result.totalPoints}\n` +
                        `üí≥ Remaining Points: ${result.remainingPoints}\n\n` +
                        `üìç Delivery Address:\n${address}\n\n` +
                        `Your order will be delivered soon!`);

                    document.getElementById('cart-modal').classList.add('hidden');
                    document.getElementById('delivery-address').value = '';
                } else {
                    const error = await response.json();
                    alert('‚ùå Checkout Failed\n\n' + (error.message || 'Please try again'));
                }
            } catch (error) {
                alert('‚ùå Error during checkout: ' + error.message);
            }
        });


        renderProducts();
        showView(viewHome);
        window.onload = initMap; // SPA initial load (Home is description) 
    </script>
</body>

</html>