<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - E-Waste Locator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Source Sans 3', sans-serif;
            background: #ffffff;
            color: #24292f;
        }
        .hr-card {
            background: #ffffff;
            border: 1px solid #d0d7de;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .hr-heading { color: #24292f; font-weight: 700; }
        .hr-text { color: #57606a; }
        .hr-green { color: #1a7f37; }
        table { border-collapse: collapse; width: 100%; }
        th { background: #f6f8fa; font-weight: 600; text-align: left; padding: 12px; border-bottom: 2px solid #d0d7de; }
        td { padding: 12px; border-bottom: 1px solid #e1e4e8; }
        tr:hover { background: #f6f8fa; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge-green { background: #dff6dd; color: #1a7f37; }
        .badge-red { background: #ffdce0; color: #d1242f; }
        .badge-yellow { background: #fff8c5; color: #7d4e00; }
        .badge-blue { background: #ddf4ff; color: #0969da; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Logout Button - Top Right -->
        <div class="flex justify-end mb-4">
            <button onclick="logoutAdmin()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                ðŸšª Logout
            </button>
        </div>
        
        <div class="mb-6">
            <h1 class="text-3xl font-bold hr-heading mb-2">Admin Dashboard</h1>
            <p class="hr-text">Product Inventory Management</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="hr-card p-4">
                <p class="text-sm hr-text mb-1">Total Products</p>
                <p class="text-2xl font-bold hr-heading" id="total-products">0</p>
            </div>
            <div class="hr-card p-4">
                <p class="text-sm hr-text mb-1">Total Stock</p>
                <p class="text-2xl font-bold hr-heading" id="total-stock">0</p>
            </div>
            <div class="hr-card p-4">
                <p class="text-sm hr-text mb-1">Total Sold</p>
                <p class="text-2xl font-bold text-blue-600" id="total-sold">0</p>
            </div>
            <div class="hr-card p-4">
                <p class="text-sm hr-text mb-1">Low Stock Items</p>
                <p class="text-2xl font-bold text-red-600" id="low-stock">0</p>
            </div>
            <div class="hr-card p-4">
                <p class="text-sm hr-text mb-1">Total Value</p>
                <p class="text-2xl font-bold hr-green" id="total-value">0 pts</p>
            </div>
        </div>

        <!-- Products Table -->
        <div class="hr-card p-6">
            <div class="mb-4">
                <h2 class="text-xl font-bold hr-heading">Products Inventory</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Price (pts)</th>
                            <th>Initial Stock</th>
                            <th>Sold</th>
                            <th>Remaining</th>
                            <th>Max Order</th>
                            <th>Status</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="products-table">
                        <tr>
                            <td colspan="8" class="text-center py-8 hr-text">Loading products...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Registered Users Section -->
        <div class="hr-card p-6 mt-6">
            <h2 class="text-xl font-bold hr-heading mb-4">Registered Users</h2>
            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Points</th>
                            <th>Transactions</th>
                            <th>Registered Date</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr>
                            <td colspan="6" class="text-center py-8 hr-text">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Section -->
        <div class="hr-card p-6 mt-6">
            <h2 class="text-xl font-bold hr-heading mb-4">Recent Orders</h2>
            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Order ID</th>
                            <th>User</th>
                            <th>Items</th>
                            <th>Total Points</th>
                            <th>Delivery Address</th>
                            <th>Status</th>
                            <th>Order Date</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table">
                        <tr>
                            <td colspan="8" class="text-center py-8 hr-text">Loading orders...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Check if user is admin
        function checkAdminAccess() {
            const userStr = localStorage.getItem('ewaste_user');
            if (!userStr) {
                alert('â›” Access Denied! Please login as admin.');
                window.location.href = '/index.html';
                return false;
            }
            
            const user = JSON.parse(userStr);
            if (user.role !== 'admin') {
                alert('â›” Access Denied! Admin access required.');
                window.location.href = '/index.html';
                return false;
            }
            
            return true;
        }

        // Fetch data from MongoDB database
        async function loadDashboard() {
            // Check admin access first
            if (!checkAdminAccess()) {
                return;
            }
            try {
                console.log('Loading dashboard data...');
                
                // Load products
                const productsRes = await fetch('/api/admin/products');
                if (!productsRes.ok) {
                    throw new Error(`Products API failed: ${productsRes.status}`);
                }
                const productsData = await productsRes.json();
                console.log('Products loaded:', productsData);
                
                // Update summary cards
                document.getElementById('total-products').textContent = productsData.stats.totalProducts;
                document.getElementById('total-stock').textContent = productsData.stats.totalStock;
                document.getElementById('total-sold').textContent = productsData.stats.totalSold || 0;
                document.getElementById('low-stock').textContent = productsData.stats.lowStock;
                document.getElementById('total-value').textContent = productsData.stats.totalValue.toLocaleString() + ' pts';
                
                // Render products table
                const tableBody = document.getElementById('products-table');
                tableBody.innerHTML = '';
                
                productsData.products.forEach((product, index) => {
                    const initialStock = product.initialStock || 0;
                    const remaining = product.stock || 0;
                    const sold = product.sold || 0; // Use actual sold field from database
                    
                    // Determine status based on product.status or stock level
                    let stockStatus = product.status || 'In Stock';
                    let statusClass = 'badge-green';
                    
                    if (stockStatus === 'Out of Stock' || remaining === 0) {
                        statusClass = 'badge-red';
                    } else if (stockStatus === 'Low Stock' || remaining <= 10) {
                        statusClass = 'badge-yellow';
                    }
                    
                    const value = remaining * product.price;
                    
                    const row = `
                        <tr>
                            <td class="font-semibold">${index + 1}</td>
                            <td class="font-semibold hr-heading">${product.name}</td>
                            <td><span class="badge badge-green">${product.category}</span></td>
                            <td class="hr-green font-semibold">${product.price}</td>
                            <td class="font-semibold">${initialStock}</td>
                            <td class="text-red-600 font-semibold">${sold}</td>
                            <td class="text-green-600 font-semibold">${remaining}</td>
                            <td class="hr-text">${product.maxOrder || 10}</td>
                            <td><span class="badge ${statusClass}">${stockStatus}</span></td>
                            <td class="hr-text">${value.toLocaleString()} pts</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                
                // Load users
                const usersRes = await fetch('/api/admin/users');
                if (!usersRes.ok) {
                    throw new Error(`Users API failed: ${usersRes.status}`);
                }
                const usersData = await usersRes.json();
                console.log('Users loaded:', usersData);
                const usersTable = document.getElementById('users-table');
                
                if (!usersData.users || usersData.users.length === 0) {
                    usersTable.innerHTML = '<tr><td colspan="6" class="text-center py-8 hr-text">No registered users yet</td></tr>';
                } else {
                
                usersTable.innerHTML = '';
                usersData.users.forEach((user, index) => {
                    const date = new Date(user.createdAt).toLocaleDateString();
                    const txCount = user.transactions ? user.transactions.length : 0;
                    
                    const row = `
                        <tr>
                            <td class="font-semibold">${index + 1}</td>
                            <td class="font-semibold hr-heading">${user.name}</td>
                            <td class="hr-text">${user.email}</td>
                            <td class="hr-green font-semibold">${user.points || 0} pts</td>
                            <td class="hr-text">${txCount}</td>
                            <td class="hr-text">${date}</td>
                        </tr>
                    `;
                    usersTable.innerHTML += row;
                });
                }

                // Load orders
                const ordersRes = await fetch('/api/admin/orders');
                if (!ordersRes.ok) {
                    throw new Error(`Orders API failed: ${ordersRes.status}`);
                }
                const ordersData = await ordersRes.json();
                console.log('Orders loaded:', ordersData);
                const ordersTable = document.getElementById('orders-table');
                
                if (!ordersData.orders || ordersData.orders.length === 0) {
                    ordersTable.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-center py-8 hr-text">No orders yet</td></tr>';
                } else {
                    ordersTable.innerHTML = '';
                    ordersData.orders.forEach((order, index) => {
                        const date = new Date(order.createdAt).toLocaleDateString();
                        const time = new Date(order.createdAt).toLocaleTimeString();
                        
                        // Parse items if it's a JSON string
                        let items = order.items;
                        if (typeof items === 'string') {
                            try {
                                items = JSON.parse(items);
                            } catch (e) {
                                items = [];
                            }
                        }
                        
                        const itemsCount = items ? items.length : 0;
                        const itemsList = items ? items.map(i => i.name || 'Product').join(', ') : 'N/A';
                        
                        // Status badge colors
                        let statusClass = 'badge-green';
                        if (order.status === 'Order Placed') statusClass = 'badge-green';
                        else if (order.status === 'Processing') statusClass = 'badge-yellow';
                        else if (order.status === 'Shipped') statusClass = 'badge-blue';
                        else if (order.status === 'Delivered') statusClass = 'badge-green';
                        else if (order.status === 'pending') statusClass = 'badge-red'; // Legacy support
                        
                        const row = `
                            <tr>
                                <td class="font-semibold">${index + 1}</td>
                                <td class="hr-text">#${order.id}</td>
                                <td class="hr-text">User #${order.userId}</td>
                                <td class="hr-text">${itemsCount} items</td>
                                <td class="hr-green font-semibold">${order.totalPoints} pts</td>
                                <td class="hr-text" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${order.deliveryAddress}</td>
                                <td><span class="badge ${statusClass}">${order.status}</span></td>
                                <td class="hr-text">${date} ${time}</td>
                            </tr>
                        `;
                        ordersTable.innerHTML += row;
                    });
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                console.error('Error stack:', error.stack);
                alert('Error loading dashboard: ' + error.message);
                document.getElementById('products-table').innerHTML = 
                    `<tr><td colspan="8" class="text-center py-8 text-red-600">Error: ${error.message}</td></tr>`;
                document.getElementById('users-table').innerHTML = 
                    `<tr><td colspan="6" class="text-center py-8 text-red-600">Error: ${error.message}</td></tr>`;
                document.getElementById('orders-table').innerHTML = 
                    `<tr><td colspan="8" class="text-center py-8 text-red-600">Error: ${error.message}</td></tr>`;
            }
        }
        
        // Logout function
        function logoutAdmin() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('ewaste_token');
                localStorage.removeItem('ewaste_user');
                alert('âœ… Logged out successfully!');
                window.location.href = '/index.html';
            }
        }
        
        // Load dashboard on page load
        loadDashboard();
        
        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
